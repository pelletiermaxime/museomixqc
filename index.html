<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script type="text/javascript" src="scenejs.js"></script>
    <script src="keymaster.js"></script>
</head>
<body>
	<style>
		body  { border: 0; margin: 0; overflow: hidden;  }
		video {  display: block; margin: 0; width:100%; height: auto; }
	</style>

	<video id="video" width="1920" height="1080" autoplay style="display: none"></video>
    <canvas id="bc" width="1920" height="1080"  style="display: block;position: absolute; width: 100%; height: auto;left: 0;top:0;z-index:0"></canvas>
    <canvas id="fc" width="1920" height="1080"  style="display: block;position: absolute; width: 100%; height: auto;left: 0;top:0;z-index:999"></canvas>

	<script>

        // Preload mask image
        mask_image = new Image();
        mask_image.src = 'img/video_mask.png';

		// Put event listeners into place
		window.addEventListener("DOMContentLoaded", function() {
			// Grab elements, create settings, etc.
				video = document.getElementById("video"),
				videoObj = { "video": true },
				errBack = function(error) {
					console.log("Video capture error: ", error.code); 
				};

			// Put video listeners into place
			if(navigator.getUserMedia) { // Standard
				navigator.getUserMedia(videoObj, function(stream) {
					video.src = stream;
					video.play();
				}, eorrBack);
			} else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
				navigator.webkitGetUserMedia(videoObj, function(stream){
					video.src = window.webkitURL.createObjectURL(stream);
					video.play();
				}, errBack);
			} else if(navigator.mozGetUserMedia) { // WebKit-prefixed
				navigator.mozGetUserMedia(videoObj, function(stream){
					video.src = window.URL.createObjectURL(stream);
					video.play();
				}, errBack);
			}

		}, false);


        document.addEventListener('DOMContentLoaded', function(){
            var v = document.getElementById('video');
            var fcanvas = document.getElementById('fc');
            var bcanvas = document.getElementById('bc');
            var fc = fcanvas.getContext('2d');
            var bc = bcanvas.getContext('2d');


            v.addEventListener('play', function(){
                draw();
            },false);

            function draw() {
                if(v.paused || v.ended) return false;
                fc.drawImage(v,0,0, 1920, 1080);
                fc.globalCompositeOperation = 'destination-out';

                fc.beginPath();
                fc.moveTo(0, 0);
                fc.lineTo(1920,0);
                fc.lineTo(1920, 500);
                fc.lineTo(0, 500);
                fc.closePath();
                fc.fill();
                fc.globalCompositeOperation = 'source-over'
                
                bc.drawImage(v,0,0, 1920, 1080);

                window.requestAnimationFrame(draw);
            }

        },false);


	</script>


<script>
// Using the "import/obj" node to import a raptor mesh from .OBJ format
// Internally, the node uses the K3D library for parsing - http://k3d.ivank.net/

// Point SceneJS to the bundled plugins
SceneJS.setConfigs({
    pluginPath: "../plugins"
});

// Create a scene
var scene = SceneJS.createScene({
    
    transparent: true,
    nodes: [

        // Mouse-orbited camera,implemented by plugin at
        // http://scenejs.org/api/latest/plugins/node/cameras/orbit.js
        {
            type: "cameras/orbit",
            yaw: -40,
            pitch: -20,
            zoom: 200,
            zoomSensitivity: 20.0,

            nodes: [

                // Move the raptor a bit to centre it
                {
                    id: "myMaterial",
                    type: "translate", y: -30, z: -20,
                    nodes: [
                        {
                            type: "texture",
                            src: "models/obj/raptor.jpg",

                            nodes:[
                            {
                                type:"rotate",
                                id:"myRotate",
                                y:1.0,
                                angle:0,

                                nodes: [
                                    {
                                        type: "import/obj",
                                        src: "models/obj/raptor.obj"
                                    }
                                ]
                            }
                        ]
                        },
                                           ],
                }
            ]
        }
    ]
});
var rotate = true;
scene.getNode("myRotate", function (myRotate) {

    var angle = 0;

    scene.on("tick", function () {
        if (rotate) {
           //  myRotate.setAngle(angle += 0.5);
        }
    });
});

var canvas = scene.getCanvas();

var translate = -200;
var x = 0;
var y = 0;
var angle = 0;
key('c', function(){
    scene.getNode("myRotate", function (myRotate) {
        myRotate.setAngle(angle += 90);
    });
});
canvas.addEventListener('mousedown', function() {
    scene.getNode("myRotate", function (myRotate) {
        myRotate.setAngle(angle += 90);
    });
    // rotate = !rotate;
    // scene.addNode({
    //     type: "translate", z: translate, x: x, y: y,
    //     nodes: [
    //         {
    //             type: "geometry/teapot"
    //         }
    //     ],
    // });
     scene.getNode("myMaterial", function(myMaterial) {
         myMaterial.addNode({
             type: "translate", z: translate, x: x, y: y,
             nodes: [
                 // {
                 //     type: "geometry/teapot"
                 // }
                 {
                     type: "texture",
                     src: "models/obj/raptor.jpg",

                     nodes:[
                     {
                         type: "import/obj",
                         src: "models/obj/raptor.obj"
                     }
                     ]
                 }
             ],
         });
     });
    translate += 20;
    x += 5;
    y += 5;
}, true);

</script>
</body>
</html>
