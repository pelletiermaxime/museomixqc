<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="headtrackr.js"></script>   
    <script type="text/javascript" src="scenejs.js"></script>
    <script src="keymaster.js"></script>
</head>
<body>
	<style>
		body  { border: 0; margin: 0; overflow: hidden;  }
		video {  display: block; margin: 0; width:50%; height: auto; }
	</style>

	<video id="webCamWindow" autoplay></video>

		 <script type="text/javascript" src="js/global.js"></script>
                <script type="text/javascript" src="js/MotionDetector/WebCamCapture.js"></script>
                <script type="text/javascript" src="js/MotionDetector/ImageCompare.js"></script>
                <script type="text/javascript" src="js/MotionDetector/Core.js"></script>
                <script type="text/javascript" src="js/main.js"></script>

                <canvas id="c" width="640" height="480" style="position:absolute;top:0; left:0"></canvas>

                <script type="text/javascript">
                        var tCanvas = document.getElementById("c");
                </script>

	
<script>
// Using the "import/obj" node to import a raptor mesh from .OBJ format
// Internally, the node uses the K3D library for parsing - http://k3d.ivank.net/

// Point SceneJS to the bundled plugins
SceneJS.setConfigs({
    pluginPath: "../plugins"
});

// Create a scene
var scene = SceneJS.createScene({
    
    transparent: true,
    nodes: [

        // Mouse-orbited camera,implemented by plugin at
        // http://scenejs.org/api/latest/plugins/node/cameras/orbit.js
        {
            type: "cameras/orbit",
            yaw: -40,
            pitch: -20,
            zoom: 200,
            zoomSensitivity: 20.0,

            nodes: [

                // Move the raptor a bit to centre it
                {
                    id: "myMaterial",
                    type: "translate", y: -30, z: -20,
                    nodes: [
                        {
                            type: "texture",
                            src: "models/obj/raptor.jpg",

                            nodes:[
                            {
                                type:"rotate",
                                id:"myRotate",
                                y:1.0,
                                angle:0,

                                nodes: [
                                    {
                                        type: "import/obj",
                                        src: "models/obj/raptor.obj"
                                    }
                                ]
                            }
                        ]
                        },
                                           ],
                }
            ]
        }
    ]
});
var rotate = true;
scene.getNode("myRotate", function (myRotate) {

    var angle = 0;

    scene.on("tick", function () {
        if (rotate) {
           //  myRotate.setAngle(angle += 0.5);
        }
    });
});

var canvas = scene.getCanvas();

var translate = -200;
var x = 0;
var y = 0;
var angle = 0;
key('c', function(){
    scene.getNode("myRotate", function (myRotate) {
        myRotate.setAngle(angle += 90);
    });
});
canvas.addEventListener('mousedown', function() {
    scene.getNode("myRotate", function (myRotate) {
        myRotate.setAngle(angle += 90);
    });
    // rotate = !rotate;
    // scene.addNode({
    //     type: "translate", z: translate, x: x, y: y,
    //     nodes: [
    //         {
    //             type: "geometry/teapot"
    //         }
    //     ],
    // });
     scene.getNode("myMaterial", function(myMaterial) {
         myMaterial.addNode({
             type: "translate", z: translate, x: x, y: y,
             nodes: [
                 // {
                 //     type: "geometry/teapot"
                 // }
                 {
                     type: "texture",
                     src: "models/obj/raptor.jpg",

                     nodes:[
                     {
                         type: "import/obj",
                         src: "models/obj/raptor.obj"
                     }
                     ]
                 }
             ],
         });
     });
    translate += 20;
    x += 5;
    y += 5;
}, true);

var videoInput = document.getElementById('video');
//var canvasInput = document.getElementById('inputCanvas');
var canvasInput = scene.getCanvas();

//var htracker = new headtrackr.Tracker();
var htracker = new headtrackr.Tracker({altVideo : {ogv : "./media/capture5.ogv", mp4 : "./media/capture5.mp4"}, calcAngles : true, ui : false, headPosition : false, debug : debugOverlay});
htracker.init(videoInput, canvasInput);
htracker.start();

document.addEventListener("facetrackingEvent", function( event ) {
    // clear canvas
    overlayContext.clearRect(0,0,320,240);
    // once we have stable tracking, draw rectangle
    if (event.detection == "CS") {
        overlayContext.translate(event.x, event.y)
        overlayContext.rotate(event.angle-(Math.PI/2));
        overlayContext.strokeStyle = "#00CC00";
        overlayContext.strokeRect((-(event.width/2)) >> 0, (-(event.height/2)) >> 0, event.width, event.height);
        overlayContext.rotate((Math.PI/2)-event.angle);
        overlayContext.translate(-event.x, -event.y);
    }
});

</script>
</body>
</html>
